name: Build & Publish Resumes

on:
  push:
    paths:
      - '**.tex'
      - '.github/workflows/build.yml'
      - 'fonts/**'
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: build-resume
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache apt archives
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-archives-texlive-v1
          restore-keys: |
            ${{ runner.os }}-apt-archives-

      - name: Install TeX Live + LuaLaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-luatex texlive-latex-recommended texlive-latex-extra \
            texlive-xetex texlive-fonts-recommended

      - name: Build PDFs (EN, RU, FR)
        run: |
          lualatex -interaction=nonstopmode -halt-on-error -jobname="Eugene-Maslovich-resume-en" '\def\resumeLang{en}\input{resume.tex}'
          lualatex -interaction=nonstopmode -halt-on-error -jobname="Evgenii-Maslovich-resume-ru" '\def\resumeLang{ru}\input{resume.tex}'
          lualatex -interaction=nonstopmode -halt-on-error -jobname="Eugene-Maslovitch-resume-fr" '\def\resumeLang{fr}\input{resume.tex}'
          lualatex -interaction=nonstopmode -halt-on-error -jobname="Evgenii-Maslovich-resume-ru-nt" '\def\resumeLang{ru}\def\customSpacing{wide}\def\noTutor{true}\input{resume.tex}'

      # Optional: keep as build artifact too (handy for debugging)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: resumes
          path: |
            Eugene-Maslovich-resume-en.pdf
            Evgenii-Maslovich-resume-ru.pdf
            Eugene-Maslovitch-resume-fr.pdf
            Evgenii-Maslovich-resume-ru-nt.pdf

      - name: Compute timestamp
        id: ts
        run: echo "ts=$(date -u '+%Y-%m-%d %H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Publish to single "latest" release
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Latest Resume PDFs
          body: |
            Auto-updated PDFs from CI.
            Last build (UTC): ${{ steps.ts.outputs.ts }}
            - EN: Eugene-Maslovich-resume-en.pdf
            - RU: Evgenii-Maslovich-resume-ru.pdf
            - FR: Eugene-Maslovitch-resume-fr.pdf
            - RU (nt): Evgenii-Maslovich-resume-ru-nt.pdf
          artifacts: |
            Eugene-Maslovich-resume-en.pdf,
            Evgenii-Maslovich-resume-ru.pdf,
            Eugene-Maslovitch-resume-fr.pdf,
            Evgenii-Maslovich-resume-ru-nt.pdf,
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
